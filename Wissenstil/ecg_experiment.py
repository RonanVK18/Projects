# -*- coding: utf-8 -*-
"""ECG_Experiment.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/16lH6oqgWpv9goH-lXqHrsXK7Q164eBge
"""

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.express as px

from google.colab import drive
drive.mount('/content/drive')

file_path1 = '/content/drive/MyDrive/Colab Notebooks/mitbih_train.csv'
file_path2 = '/content/drive/MyDrive/Colab Notebooks/mitbih_test.csv'

mit_train = pd.read_csv(file_path1)
mit_test = pd.read_csv(file_path2)

mit_train

mit_test

print('train set classes: ', mit_train.iloc[:, -1].unique())
print('test set classes: ', mit_test.iloc[:, -1].unique())

mit_train.iloc[:, -1] = mit_train.iloc[:, -1].astype('int64')
mit_test.iloc[:, -1] = mit_test.iloc[:, -1].astype('int64')

labels = {
    0: "Normal",
    1: "Artial Premature",
    2: "Premature ventricular contraction",
    3: "Fusion of ventricular and normal",
    4: "Fusion of paced and normal"
}

value_counts = mit_train.iloc[:,-1].value_counts().rename(labels)

from imblearn.over_sampling import RandomOverSampler

data = mit_train.iloc[:, :187]
labels = mit_train.iloc[:, 187]

ros = RandomOverSampler(random_state=42)


data_resampled, labels_resampled = ros.fit_resample(data, labels)

train_df = pd.concat([data_resampled, labels_resampled], axis=1)

train_df.shape

from sklearn.model_selection import train_test_split

x_train, x_val, y_train, y_val = train_test_split(train_df.iloc[:, :187],
                                                train_df.iloc[:, 187],
                                                test_size= 0.2,
                                                stratify=train_df.iloc[:, 187],
                                                random_state=42)

x_test = mit_test.iloc[:, :187]
y_test = mit_test.iloc[:, 187]

x_train = x_train.values
x_val = x_val.values
x_test = x_test.values

print('x_train shape: ', x_train.shape)
print('y_train shape: ', y_train.shape)
print('x_val shape: ', x_val.shape)
print('y_val shape: ', y_val.shape)
print('x_test shape: ', x_test.shape)
print('y_test shape: ', y_test.shape)

x_train = x_train.reshape(x_train.shape[0], -1, 1)
x_val = x_val.reshape(x_val.shape[0], -1, 1)
x_test = x_test.reshape(x_test.shape[0], -1, 1)

import tensorflow as tf

y_train = tf.keras.utils.to_categorical(y_train)

y_val = tf.keras.utils.to_categorical(y_val)

y_test = tf.keras.utils.to_categorical(y_test)

from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Conv1D, LSTM, MaxPool1D, Flatten, Dense, BatchNormalization, Input
from tensorflow.keras.callbacks import EarlyStopping, ModelCheckpoint, ReduceLROnPlateau

model_cnn_lstm = Sequential([
    Input(shape=(x_train.shape[1:])),

    Conv1D(64, kernel_size=6, activation='relu'),
    BatchNormalization(),
    MaxPool1D(pool_size=3, strides=2, padding="same"),

    Conv1D(64, kernel_size=3, activation='relu'),
    BatchNormalization(),
    MaxPool1D(pool_size=2, strides=2, padding="same"),

    Conv1D(64, kernel_size=3, activation='relu'),
    BatchNormalization(),
    MaxPool1D(pool_size=2, strides=2, padding="same"),

    LSTM(64, return_sequences=True, activation="tanh"),

    LSTM(32, activation="tanh"),

    Flatten(),

    Dense(64, activation='relu'),
    Dense(32, activation='relu'),
    Dense(5, activation='softmax')
    ])

model_cnn_lstm.compile(optimizer='adam',loss='categorical_crossentropy', metrics=['accuracy'])

callbacks = [
    EarlyStopping(monitor='val_loss', patience=8),
    ReduceLROnPlateau(monitor='val_loss', patience=20, min_lr=1e-6, cooldown=20),
    ModelCheckpoint(filepath=filepath, monitor='val_loss', save_best_only=True)
]

history = model_cnn_lstm.fit(x_train, y_train, epochs=10, callbacks=callbacks, batch_size=32, validation_data=(x_val, y_val),verbose=1)

model_cnn_lstm.save("ECGMODEL.h5")

train_score = model_cnn_lstm.evaluate(x_train, y_train)
validation_score = model_cnn_lstm.evaluate(x_val, y_val)

print('Accuracy Train data: ', train_score[1])
print('Accuracy Validation data: ', validation_score[1])

y_pred = model_cnn_lstm.predict(x_test)

from sklearn.metrics import classification_report

y_test_labels = np.argmax(y_test, axis=1)
y_pred_labels = np.argmax(y_pred, axis=1)

print(classification_report(y_test_labels, y_pred_labels))